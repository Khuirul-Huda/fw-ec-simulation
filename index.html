<!--
    Muhammad Khuirul Huda 
    https://github.com/Khuirul-Huda/fw-ec-simulation
 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
    font-family: 'Inter', sans-serif;
    }
</style>
    <title>Firewall dan Enkripsi | Prototipe versi digital</title>
</head>

<body class="bg-gradient-to-r from-indigo-400 to-cyan-400">
    <header>

    </header>
    <main class="container mx-auto">
        <section class=" rounded-lg p-5 m-5 bg-white">
            <h2 class="font-bold text-3xl text-indigo-800">1. Firewall</h2>
            <p class="text-indigo-400">Simulasi sederhana bagaimana firewall bekerja..</p>
            <div>
                <button id="start-sim"
                    class="p-1 px-2 bg-indigo-300 text-white shadow-md shadow-indigo-300 rounded-md text-sm transition-all hover:-translate-y-1">Mulai</button>
                <button id="reset-sim"
                    class="p-1 px-2 bg-indigo-300 text-white shadow-md shadow-indigo-300 rounded-md text-sm transition-all hover:-translate-y-1">Reset</button>
                    <button id="reset-firewall"
                    class="p-1 px-2 bg-indigo-300 text-white shadow-md shadow-indigo-300 rounded-md text-sm transition-all hover:-translate-y-1">Reset Firewall</button>

            </div>
            <div class="my-5 h-10 w-full relative">
                <div class="absolute ring-4 ring-green-200  top-0  h-10 bg-green-500 rounded-lg p-2 text-white"
                    id="paket-prototipe">Packet</div>
                <div class="absolute ring-4 ring-blue-200 top-0  h-10 bg-blue-500 rounded-lg p-2 text-white"
                    id="client-prototipe">Client</div>
                <div class="absolute   hover:scale-105 transition-all left-1/2 h-10  bg-purple-300 flex items-center lg:px-32 sm:px-8 md:px-10 px-3 ring-4 text-white ring-purple-200"
                    id="firewall-prototipe"> <span>Firewall</span>
                </div>
                <div class="absolute w-18 h-10 top-0 right-0  bg-blue-400 ring-4 ring-blue-200 text-white rounded-lg px-5 flex items-center"
                    id="server-prototipe">Server</div>
            </div>
            <div class="flex flex-wrap justify-center">
                <form action="" id="paket" class="shadow-md border rounded-md m-5 p-5 flex flex-col">
                    <h3 class="font-bold text-lg text-indigo-800">Konfigurasi Paket</h3>
                    <label for="destination-port" class="text-indigo-400">Destination Port: </label>
                    <input class="border p-1 rounded-md text-indigo-400" value="80" placeholder="80 (default)" type="number"
                        name="destination-port" id="destination-port">
                    <!-- <button class="block p-2 mt-1 bg-yellow-300 hover:-translate-y-1 transition-all">Kirim Paket</button> -->

                </form>
                <form action="" id="firewall-rules" class="shadow-md border rounded-md m-5 p-5 flex flex-col">
                    <h3 class="font-bold text-lg text-indigo-800">Aturan Firewall</h3>
                    <label for="port-input" class=" text-indigo-400">Masukkan Port:</label>
                    <input class="border rounded-md p-2 text-indigo-400" placeholder="80" type="text" name="port-input" id="port-input"
                        required>

                    <label for="rule-type" class="text-indigo-400">Jenis Aturan:</label>
                    <select name="rule-type" class="my-1 p-2 rounded-md mb-2 text-indigo-400" id="rule-type">
                        <option value="ALLOW">ALLOW</option>
                        <option value="DENY">DENY</option>
                    </select>

                    <button type="submit"
                        class="p-1 px-2 bg-indigo-300 text-white shadow-md shadow-indigo-300 rounded-md text-sm transition-all hover:-translate-y-1">Tambah</button>
                </form>
            </div>

            <div class="border p-4 rounded-lg">
                <h3 class="font-bold text-indigo-800">Daftar Aturan Firewall</h3>
                <div id="firewall-rules-list">
                    <table class="table-fixed w-full text-center table text-indigo-400">
                        <thead>
                            <tr>
                                <th>Port</th>
                                <th>Tipe</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-firewall">
                            <tr>
                                <td></td>
                                <td>ALLOW</td>
                            </tr>
                        </tbody>
                    </table>

                </div>

            </div>


        </section>

        <section class=" rounded-lg p-5 m-5 bg-white">
            <h2 class="font-bold text-3xl text-indigo-800">2. Enkripsi</h2>
            <p class="text-indigo-400">Simulasi sederhana bagaimana enkripsi bekerja..</p>

        </section>
    </main>
    <footer>

    </footer>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.2/lib/anime.min.js"></script>
    <script>

        tippy('#paket-prototipe', {
            content: 'Source IP: 20.20.20.20 <br> Source Port: 65746 <br> Destination IP: 36.72.0.102 <br> Destination Port: (sesuai konfigurasi)',
            allowHTML: true
        })

        tippy('#firewall-prototipe', {
            content: 'Lapisan firewall, daftar rule ada di bawah',
            allowHTML: true
        })


        tippy('#server-prototipe', {
            content: 'Public IP: 36.72.0.102',
            allowHTML: true
        })


        // Form handling


        function getPacketDestinationPort() {
            return parseInt(document.getElementById('destination-port').value)
        }


        //  START

        let firewallRules = [{ "port": 22, "type": "ALLOW" }]
        let isRunning = false
        updateLayoutFirewall()

        const pixelRatio = window.devicePixelRatio || 1
        
        if (screen.width * pixelRatio < 1366) {
            showNotification('Gunakan perangkat desktop')
        }

        document.getElementById('firewall-rules').addEventListener('submit', (event) => {
            event.preventDefault();
            addFirewallRule(Number.parseInt(document.getElementById('port-input').value), document.getElementById('rule-type').value)
            updateLayoutFirewall()
        })

        document.getElementById('start-sim').addEventListener('click', (e) => {
            onStartClicked()
        })

        document.getElementById('reset-sim').addEventListener('click', (e) => {
            onResetPosClicked()
        })

        document.getElementById('reset-firewall').addEventListener('click', (e) => {
            clearFirewallRules()
        })


        function addFirewallRule(port, type) {
            $isAvailable = ruleExist(port)
            if ($isAvailable != null) {
                updateFirewallRule($isAvailable, type)
                showNotification('Berhasil diupdate')

                return
            } else {
                firewallRules.push({
                    port: port,
                    type: type
                })
                showNotification('Berhasil ditambahkan')
            }
        }

        function updateFirewallRule(index, newVal) {
            firewallRules[index]['type'] = newVal
        }

        function isBlocked(port) {
            index = ruleExist(port)

            if (index == null || firewallRules[index]['type'] == 'DENY') return true
            return false
        }

        /**
         * return null or index number
         * */
        function ruleExist(port) {
            for (let index = 0; index < firewallRules.length; index++) {

                if (firewallRules[index]['port'] === port) {

                    return index
                }

            }
            return null
        }

        function updateLayoutFirewall() {
            let newDataHTML = ''
            firewallRules.forEach((rule) => {
                newDataHTML += `<tr><td>${rule['port']}</td><td>${rule['type']}</td></tr>`
            })
            document.getElementById('tbody-firewall').innerHTML = newDataHTML
        }

        // Library related
        function showNotification(msg) {
            Toastify({

                text: msg,

                duration: 1500

            }).showToast();
        }

        function startFirewallSim(delivered = true) {
            showNotification('Paket mulai dikirim')
            isRunning = true
            // anime.speed = 0.
            if (delivered) {

                anime({
                    targets: '#paket-prototipe',
                    top: '0',
                    right: '0',
                    duration: 5000,
                    easing: 'linear',
                    complete: (anim) => {
                        showNotification('Paket terkirim')
                        isRunning = false
                    }
                });

            } else {
                anime({
                    targets: '#paket-prototipe',
                    top: '0',
                    right: '50%',
                    duration: 2500,
                    easing: 'linear',
                    complete: (anim) => {
                        showNotification('Paket gagal dikirim!')
                        isRunning = false
                    }
                });


            }
        }

        function onStartClicked(reset = false) {
            if (isRunning) return
            if (!reset) {
                onResetPosClicked(true)
                return
            }
            
            if (isBlocked(getPacketDestinationPort())) {
                startFirewallSim(false)
            }
            else {
                startFirewallSim()
            }

        }

        function onResetPosClicked(start = false) {
            if (isRunning) return
            if (start) {
                anime({
                targets: '#paket-prototipe',
                top: '0',
                right: '95%',
                duration: 0,
                easing: 'linear',
                complete: (anim) => {
                    onStartClicked(true)
                }
            });
            return
            }
            anime({
                targets: '#paket-prototipe',
                top: '0',
                right: '95%',
                duration: 100,
                easing: 'linear'
            });
            
        }

        function clearFirewallRules() {
            firewallRules = []
            updateLayoutFirewall()
            showNotification('Firewall direset')
        }


    </script>
</body>


</html>